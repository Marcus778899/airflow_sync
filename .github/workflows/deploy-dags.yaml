name: Deploy Airflow DAGs

on:
  push:
    branches:
      - main
    paths:
      - 'dags/**'
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: self-hosted
    defaults:
      run:
        shell: bash

    env:
      AIRFLOW_DAG_DIR: ${{ secrets.AIRFLOW_DAG_DIR }}
      AIRFLOW_RELEASES_DIR: ${{ secrets.AIRFLOW_RELEASES_DIR }}
      AIRFLOW_NAME: ${{ secrets.AIRFLOW_NAME }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sync DAGs to new release
        run: |
          TS=$(date -u +%Y%m%d_%H%M%S)
          echo "TS=$TS" >> $GITHUB_ENV

          RELEASE_DIR="${AIRFLOW_RELEASES_DIR}/${TS}"
          mkdir -p "$RELEASE_DIR"

          echo "Syncing DAGs using rsync..."
          rsync -av --delete dags/ "$RELEASE_DIR"/

          echo "DAGs synced to: $RELEASE_DIR"
          ls -al "$RELEASE_DIR"

      - name: Switch symlink atomically
        run: |
          CURRENT_LINK="${AIRFLOW_DAG_DIR}"
          NEW_RELEASE="${AIRFLOW_RELEASES_DIR}/${TS}"

          echo "Switching symlink: ${CURRENT_LINK} -> ${NEW_RELEASE}"
          ln -sfn "$NEW_RELEASE" "$CURRENT_LINK"

          # Trigger DAG reload
          find "$CURRENT_LINK" -type f -name '*.py' -exec touch {} +

          echo "Symlink updated."

      - name: Refresh DAGs inside Airflow container
        run: |
          CID=$(docker ps --filter "name=$AIRFLOW_NAME" --format "{{.ID}}" | head -n 1)

          if [ -z "$CID" ]; then
            echo "Airflow container not found!"
            exit 1
          fi

          echo "Refreshing DAG list..."
          docker exec "$CID" airflow dags list >/dev/null 2>&1 &&
            echo "DAGs loaded successfully." ||
            (echo "Failed to load DAGs!" && exit 1)

      - name: Cleanup old releases (keep last 5)
        run: |
          cd "$AIRFLOW_RELEASES_DIR"
          ls -1t | tail -n +6 | xargs -r rm -rf
          echo "Old releases cleaned."